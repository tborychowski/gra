<section class="store-front">
	<div class="table-wrap">
		<h2>Cargo</h2>
		<table>
			<thead><tr>
				<td class="item-name">Name</td>
				<td>Amount</td>
				<td>Paid</td>
				<td>Can get</td>
				<td></td>
			</tr></thead>
			<tbody>
				{#each Object.entries($cargo) as [itemId, item]}
				<tr>
					<td class="item-name">{$models.wares[itemId].name}</td>
					<td>{item.amount}</td>
					<td>{item.price}</td>
					<td>{$prices[itemId] && $prices[itemId].price}</td>
					<td><button class="btn" on:click="onclick('sell', itemId, item, this)">Sell</button></td>
				</tr>
				{/each}
			</tbody>
		</table>
	</div>
	<div class="table-wrap">
		<h2>Market</h2>
		<table>
			<thead><tr>
				<td class="item-name">Name</td>
				<td>Price</td>
				<td></td>
			</tr></thead>
			<tbody>
				{#each Object.entries($prices) as [itemId, item]}
					{#if item.show}
					<tr>
						<td class="item-name">{item.name}</td>
						<td>{item.price}</td>
						<td><button class="btn" on:click="onclick('buy', itemId, item, this)">Buy</button></td>
					</tr>
					{/if}
				{/each}
			</tbody>
		</table>
	</div>


	<x-window ref:window>
		<h1 class="title">Market</h1>
		<div class="content">
			<h2>How much do you want to {action}?</h2>
			<form ref:form on:submit="onsubmit(event)">
				<input bind:value="amount" class="{error ? 'error' : ''}">
			</form>
			{#if error}
				<div class="error">{error}</div>
			{:elseif info}
				<div class="info">{info}</div>
			{/if}
		</div>
		<div class="buttons">
			<button class="btn" on:click="hidewindow()">Cancel</button>
			<button class="btn success" on:click="onsubmit()">OK</button>
		</div>
	</x-window>
</section>


<script>
import Data from '../data';

export default {
	store: () => Data.Store,
	data () {
		return {
			action: 'sell',
			amount: 0,
			itemId: null,
			item: null,
			error: '',
			info: '',
		};
	},
	onstate({ changed, current, previous }) {
		if (changed.amount) this.calcInfo(current.amount);
	},

	methods: {

		hidewindow () {
			this.refs.window.hide();
			this.set({ amount: 0, error: '' });
		},
		showwindow (el) { this.refs.window.show(el); },

		calcInfo (amount) {
			const {action, item, itemId} = this.get();
			if (!item) return;

			this.set({ error: '' });
			if (action === 'buy') {
				const {cash, cargoLoad, ship} = this.store.get();
				const max = Math.floor(cash / item.price);
				if (cargoLoad + amount > ship.cargo) return this.set({ error: 'You don\'t have enough room!' });
				if (amount > max) return this.set({ error: 'You don\'t have enough cash!' });
			}

			const itemPrice = (action === 'sell' ? this.store.get().prices[itemId].price : item.price);
			this.set({info: `${amount} x ${itemPrice} = ${amount * itemPrice}` });
		},

		onclick (action, itemId, item, el) {
			let amount = 0;
			if (action === 'sell') amount = item.amount;
			else {
				const {cash, cargoLoad, ship} = this.store.get();
				const max = Math.floor(cash / item.price);
				amount = Math.min(max, ship.cargo - cargoLoad);
			}

			this.set({ itemId, item, action, amount, error: '' });
			this.showwindow(el);
		},

		onsubmit (e) {
			if (e) e.preventDefault();

			let {action, amount, item, itemId, error} = this.get();
			amount = parseInt(amount, 10);

			if (action === 'buy' && error === '') this.store.buy(itemId, amount);
			else this.store.sell(itemId, amount);

			this.hidewindow();
		},
	}
};
</script>
